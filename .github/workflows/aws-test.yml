name: AWS Cookbook Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_platform:
        description: 'Platform to test'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - ubuntu-20.04
        - centos-8
        - amazon-linux-2
        - windows-2019

env:
  CHEF_LICENSE: accept-silent
  AWS_REGION: us-west-2

jobs:
  # Quick validation
  validate:
    name: Quick Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        
    - name: Install Chef Workstation
      run: |
        wget -q https://packages.chef.io/files/stable/chef-workstation/23.10.1013/ubuntu/20.04/chef-workstation_23.10.1013-1_amd64.deb
        sudo dpkg -i chef-workstation_23.10.1013-1_amd64.deb
        
    - name: Syntax and lint check
      run: |
        find . -name "*.rb" -exec ruby -c {} \;
        chef exec cookstyle .

  # AWS EC2 Testing
  aws-integration:
    name: AWS EC2 Integration Test
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    strategy:
      fail-fast: false
      matrix:
        platform: 
          - ubuntu-20.04
          - amazon-linux-2
          - windows-2019
        include:
          - platform: ubuntu-20.04
            suite: default
          - platform: amazon-linux-2  
            suite: enterprise
          - platform: windows-2019
            suite: windows-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        
    - name: Install Chef Workstation
      run: |
        wget -q https://packages.chef.io/files/stable/chef-workstation/23.10.1013/ubuntu/20.04/chef-workstation_23.10.1013-1_amd64.deb
        sudo dpkg -i chef-workstation_23.10.1013-1_amd64.deb
        
    - name: Install Test Kitchen EC2
      run: |
        gem install kitchen-ec2 kitchen-inspec
        
    - name: Set up SSH key for EC2
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/chef-testing.pem
        chmod 600 ~/.ssh/chef-testing.pem
        
    - name: Run cookbook test on AWS EC2
      env:
        AWS_SSH_KEY_NAME: chef-testing
        AWS_SSH_KEY_PATH: ~/.ssh/chef-testing.pem
        AWS_SUBNET_ID: ${{ secrets.AWS_SUBNET_ID }}
        AWS_SECURITY_GROUP_ID: ${{ secrets.AWS_SECURITY_GROUP_ID }}
        KITCHEN_YAML: .kitchen.aws.yml
      run: |
        # Skip if specific platform requested and doesn't match
        if [[ "${{ github.event.inputs.test_platform }}" != "all" && "${{ github.event.inputs.test_platform }}" != "${{ matrix.platform }}" ]]; then
          echo "Skipping ${{ matrix.platform }} (only testing ${{ github.event.inputs.test_platform }})"
          exit 0
        fi
        
        echo "ðŸš€ Testing time-cookbook on AWS EC2 (${{ matrix.platform }})"
        echo "Instance will be created, cookbook applied, and tests run..."
        
        # Run the test
        chef exec kitchen test ${{ matrix.suite }}-${{ matrix.platform }}
        
    - name: Cleanup on failure
      if: failure()
      env:
        AWS_SSH_KEY_NAME: chef-testing
        AWS_SUBNET_ID: ${{ secrets.AWS_SUBNET_ID }}
        AWS_SECURITY_GROUP_ID: ${{ secrets.AWS_SECURITY_GROUP_ID }}
        KITCHEN_YAML: .kitchen.aws.yml
      run: |
        echo "ðŸ§¹ Cleaning up failed test instances..."
        chef exec kitchen destroy ${{ matrix.suite }}-${{ matrix.platform }} || true

  # Test Results Summary
  results:
    name: Test Results Summary  
    runs-on: ubuntu-latest
    needs: [validate, aws-integration]
    if: always()
    
    steps:
    - name: Generate Summary
      run: |
        echo "## ðŸ§ª AWS Cookbook Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| AWS Integration | ${{ needs.aws-integration.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.aws-integration.result }}" == "success" ]]; then
          echo "âœ… **All tests passed!** Cookbook is ready for production deployment." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some tests failed.** Please check the logs above." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tested Platforms:" >> $GITHUB_STEP_SUMMARY
        echo "- Ubuntu 20.04 LTS (t3.small)" >> $GITHUB_STEP_SUMMARY  
        echo "- Amazon Linux 2 (t3.small)" >> $GITHUB_STEP_SUMMARY
        echo "- Windows Server 2019 (t3.small)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Coverage:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Timezone configuration" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… NTP service setup (ntpd/W32Time)" >> $GITHUB_STEP_SUMMARY  
        echo "- âœ… Service management" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Configuration validation" >> $GITHUB_STEP_SUMMARY